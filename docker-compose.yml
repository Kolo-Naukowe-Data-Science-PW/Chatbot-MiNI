version: "3.9"

volumes:
  final_storage:
  chroma_db:
  hf_cache:

x-env: &env
  PYTHONUNBUFFERED: "1"
  HF_HOME: /root/.cache/huggingface
  PYTHONPATH: /app/src
  OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}

services:
  scraper:
    build: .
    command: ["micromamba", "run", "-n", "app", "python", "-m", "src.scraper.main"]
    environment: *env
    volumes:
      - final_storage:/app/src/data/final_storage
      - hf_cache:/root/.cache/huggingface

  ingest:
    build: .
    command: ["micromamba", "run", "-n", "app", "python", "-m", "src.data_ingest.main"]
    environment:
      <<: *env
      SENTENCE_TRANSFORMER_MODEL: intfloat/multilingual-e5-base
      EMBEDDINGS_DEVICE: cpu
      CHROMA_DIR: /app/src/rag_api/chroma_db
      CHROMA_COLLECTION: mini_site
    volumes:
      - final_storage:/app/src/data/final_storage:ro
      - chroma_db:/app/src/rag_api/chroma_db
      - hf_cache:/root/.cache/huggingface
    depends_on:
      scraper:
        condition: service_completed_successfully

  api:
    build: .
    command: micromamba run -n app uvicorn src.rag_api.api:app --host 0.0.0.0 --port 8000
    environment:
      <<: *env
      CHROMA_DIR: /app/src/rag_api/chroma_db
      CHROMA_COLLECTION: mini_site
    volumes:
      - chroma_db:/app/src/rag_api/chroma_db:ro
    expose:
      - "8000"
    restart: always

  frontend:
    build: .
    command: micromamba run -n app streamlit run src/frontend/app.py --server.port 8501 --server.address 0.0.0.0
    environment:
      <<: *env
      API_URL: "http://api:8000/chat"
    ports:
      - "80:8501"
    depends_on:
      - api
    restart: always